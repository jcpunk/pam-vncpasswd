= pam_vncpasswd(8)
:doctype: manpage
:manmanual: PAM Module Reference
:mansource: pam-vncpasswd
:man-linkstyle: pass:[blue R < >]

== Name

pam_vncpasswd - PAM module for VNC password file authentication

== Synopsis

----
auth required pam_vncpasswd.so [file=PATH] [nullok]
----

== Description

*pam_vncpasswd* is a PAM module that authenticates users against a
per-user VNC password file (by default `~/.vnc/passwd`).  The password
file stores a single crypt(3) hash; the algorithm and cost parameters are
determined by *ENCRYPT_METHOD* and related settings in
_/etc/login.defs_.

This module is designed for environments where VNC servers (such as
Weston + NeatVNC) need password authentication for users whose primary
credentials are Kerberos tickets with no local password hash (e.g.,
POSIX group accounts on RHEL10).

Unlike TigerVNC's built-in password handling (8-byte, bit-reversed
obfuscation), pam_vncpasswd uses proper crypt(3) hashing with
configurable algorithms and round counts.

=== Supported Algorithms

SHA-512 ($6$)::
  Recommended when yescrypt is not available.  Uses *SHA_CRYPT_MAX_ROUNDS*
  from _/etc/login.defs_ (default 65536).

SHA-256 ($5$)::
  Similar to SHA-512 with a smaller output.  Uses *SHA_CRYPT_MAX_ROUNDS*.

yescrypt ($y$)::
  Default on modern RHEL/Fedora.  Uses *YESCRYPT_COST_FACTOR* from
  _/etc/login.defs_ (default 5, giving N=32768).  Note: yescrypt does
  **not** use a "rounds=N" syntax; the cost is encoded in the salt
  parameter string by *crypt_gensalt_ra*(3).

bcrypt ($2b$)::
  Uses logâ‚‚(rounds)=12 by default.

MD5 ($1$)::
  Legacy; not recommended.

== Module Types Provided

*auth*, *account*, *session*, *password*

Only *auth* performs meaningful work; all other module types return
*PAM_SUCCESS* immediately.

== Return Values

PAM_SUCCESS::
  Authentication succeeded, or file is missing and *nullok* is set.

PAM_AUTH_ERR::
  Password mismatch, bad file permissions, or invalid hash.

PAM_AUTHINFO_UNAVAIL::
  Password file missing and *nullok* is not set.

PAM_USER_UNKNOWN::
  User not found in the system user database.

== Options

file=_PATH_::
  Use _PATH_ as the password file instead of `~/.vnc/passwd`.
  Useful for system-wide VNC accounts or testing.

nullok::
  If the password file does not exist, return *PAM_SUCCESS* instead
  of *PAM_AUTHINFO_UNAVAIL*.  Use with caution.

== Security

*TOCTOU protection*::
  The password file is opened with *O_NOFOLLOW* to prevent symlink
  attacks.  After opening, *fstat*(2) verifies ownership (must match
  the authenticated user's UID) and permissions (must be 0600 or
  stricter).

*Constant-time comparison*::
  Password hashes are compared using a constant-time XOR accumulator
  to prevent timing side-channel attacks.

*Memory protection*::
  Plaintext passwords are locked in RAM with *mlock*(2) to prevent
  them from being written to swap.  *mlock* failure is non-fatal.

*Buffer zeroing*::
  All sensitive buffers (passwords, hashes, salts) are cleared with
  *explicit_bzero*(3) before returning.

== Files

~/.vnc/passwd::
  Per-user VNC password file (default location).

/etc/login.defs::
  Consulted at runtime for *ENCRYPT_METHOD*, *YESCRYPT_COST_FACTOR*,
  and *SHA_CRYPT_MAX_ROUNDS*.

== Example PAM Configuration

[source]
----
# /etc/pam.d/vncserver-virtual
auth    required  pam_sepermit.so
auth    required  pam_vncpasswd.so
account required  pam_unix.so
session required  pam_unix.so
----

To allow VNC access even when no VNC password file exists:

[source]
----
auth    required  pam_vncpasswd.so nullok
----

== See Also

*fnal-vncpasswd*(1), *crypt*(3), *crypt_gensalt_ra*(3), *login.defs*(5),
*pam*(8)

== Authors

Written for the Fermi National Accelerator Laboratory.
Inspired by https://github.com/art-daq/artdaq/pull/275 but uses proper
crypt(3) hashing instead of TigerVNC's obfuscation format.
